<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduFiles ‚Äî Agregar Registro</title>
    <link href="styles.css" rel="stylesheet" type="text/css">
</head>

<body class="modal modal-agregar">
    <div class="container">
        <h2>üìù Agregar Nuevo Registro</h2>

        <form id="formRegistro">
            <div class="form-group">
                <label for="nombre">Nombre del Estudiante:</label>
                <input type="text" id="nombre" required>
            </div>

            <div class="form-group">
                <label for="apellidos">Apellidos del Estudiante:</label>
                <input type="text" id="apellidos" required>
            </div>

            <div class="form-group">
                <label for="codigoEstudiante">C√≥digo de Estudiante:</label>
                <input type="text" id="codigoEstudiante">
            </div>

            <div class="form-group">
                <label for="nacionalidad">Nacionalidad:</label>
                <input type="text" id="nacionalidad">
            </div>

            <div class="form-group">
                <label for="etnia">Etnia:</label>
                <input type="text" id="etnia">
            </div>

            <div class="form-group">
                <label for="discapacidad">Discapacidad (si aplica):</label>
                <input type="text" id="discapacidad">
            </div>

            <div class="form-group">
                <label for="edad">Edad:</label>
                <input type="number" id="edad" min="5" max="29">
            </div>

            <div class="form-group">
                <label for="cedulaEstudiante">C√©dula del Estudiante:</label>
                <input type="text" id="cedulaEstudiante">
            </div>

            <div class="form-group">
                <label for="fechaNacimiento">Fecha de Nacimiento del Estudiante:</label>
                <input type="date" id="fechaNacimiento">
            </div>

            <div class="form-group">
                <label for="sexo">Sexo del Estudiante:</label>
                <select id="sexo">
                    <option value="">Seleccione una opci√≥n</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Femenino">Femenino</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>

            <div class="form-group">
                <label for="jornada">Jornada:</label>
                <select id="jornada">
                    <option value="">Seleccione una jornada</option>
                    <option value="Matutina">Matutina</option>
                    <option value="Vespertina">Vespertina</option>
                    <option value="Nocturna">Nocturna</option>
                </select>
            </div>

            <div class="form-group">
                <label for="anioLectivo">A√±o Lectivo:</label>
                <input type="text" id="anioLectivo" placeholder="2025-2026">
            </div>

            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email">
            </div>

            <div class="form-group">
                <label for="telefono">Tel√©fono:</label>
                <input type="text" id="telefono">
            </div>

            <div class="form-group">
                <label for="foto">Foto (opcional):</label>
                <input type="file" id="foto" accept="image/*">
                <div class="foto-preview-wrap">
                    <img id="fotoPreview" class="foto-preview" alt="Preview" />
                </div>
            </div>

            <div class="form-group">
                <label for="curso">Curso:</label>
                <select id="curso" required>
                    <option value="">Seleccione un curso</option>
                    <option value="Inicial 1">Inicial 1</option>
                    <option value="Inicial 2">Inicial 2</option>
                    <option value="1ro EGB">1ro EGB</option>
                    <option value="2do EGB">2do EGB</option>
                    <option value="3ro EGB">3ro EGB</option>
                    <option value="4to EGB">4to EGB</option>
                    <option value="5to EGB">5to EGB</option>
                    <option value="6to EGB">6to EGB</option>
                    <option value="7mo EGB">7mo EGB</option>
                    <option value="8vo EGB">8vo EGB</option>
                    <option value="9no EGB">9no EGB</option>
                    <option value="10mo EGB">10mo EGB</option>
                    <option value="1ro T√©cnico">1ro T√©cnico</option>
                    <option value="2do T√©cnico">2do T√©cnico</option>
                    <option value="3ro T√©cnico">3ro T√©cnico</option>
                    <option value="1ro Ciencias">1ro Ciencias</option>
                    <option value="2do Ciencias">2do Ciencias</option>
                    <option value="3ro Ciencias">3ro Ciencias</option>
                </select>
            </div>

            <div class="form-group" id="grupoParalelo">
                <label for="paralelo">Paralelo:</label>
                <select id="paralelo">
                    <option value="">N/A</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                </select>
            </div>

            <div class="form-group">
                <label for="direccion">Direcci√≥n Domiciliaria del Estudiante:</label>
                <input type="text" id="direccion">
            </div>

            <div class="form-group">
                <label for="nombreRepresentante">Nombre del Representante:</label>
                <input type="text" id="nombreRepresentante">
            </div>

            <div class="form-group">
                <label for="cedulaRepresentante">C√©dula del Representante:</label>
                <input type="text" id="cedulaRepresentante">
            </div>

            <div class="form-group">
                <label for="telefonoRepresentante">Tel√©fono del Representante:</label>
                <input type="text" id="telefonoRepresentante">
            </div>

            <div class="form-group">
                <label for="direccionRepresentante">Direcci√≥n Domiciliaria del Representante:</label>
                <input type="text" id="direccionRepresentante">
            </div>

            <hr>
            <h3>Observaciones Generales</h3>
            <div class="form-group">
                <label for="descripcionObservaciones">Descripci√≥n:</label>
                <textarea id="descripcionObservaciones" rows="3"></textarea>
            </div>

            <div class="botones">
                <button type="button" class="btn-cancelar" id="btnCancelar">Cancelar</button>
                <button type="submit" class="btn-guardar">Guardar</button>
            </div>
        </form>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        const store = require('./studentStore');

        const DEFAULT_PHOTO = `data:image/svg+xml;utf8,${encodeURIComponent(
            `<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 128 128">
                <rect width="128" height="128" rx="64" fill="#e5e7eb"/>
                <circle cx="64" cy="50" r="22" fill="#9ca3af"/>
                <path d="M26 116c7-18 15-28 38-28s31 10 38 28" fill="#9ca3af"/>
            </svg>`
        )}`;

        function readFileAsDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(String(reader.result || ''));
                reader.onerror = () => reject(new Error('No se pudo leer la imagen'));
                reader.readAsDataURL(file);
            });
        }

        async function getFotoDataUrl() {
            const input = document.getElementById('foto');
            const file = input && input.files ? input.files[0] : null;
            if (!file) return '';

            // Evitar reventar el localStorage con fotos enormes.
            const maxBytes = 300 * 1024;
            if (file.size > maxBytes) {
                alert('La foto es muy grande. Usa una imagen m√°s peque√±a (<= 300KB).');
                return '';
            }

            return await readFileAsDataUrl(file);
        }

        const fotoPreview = document.getElementById('fotoPreview');
        if (fotoPreview) fotoPreview.src = DEFAULT_PHOTO;

        const fotoInput = document.getElementById('foto');
        if (fotoInput) {
            fotoInput.addEventListener('change', async () => {
                try {
                    const dataUrl = await getFotoDataUrl();
                    if (fotoPreview) fotoPreview.src = dataUrl || DEFAULT_PHOTO;
                } catch {
                    if (fotoPreview) fotoPreview.src = DEFAULT_PHOTO;
                }
            });
        }

        document.getElementById('formRegistro').addEventListener('submit', async (e) => {
            e.preventDefault(); // Evitamos que la p√°gina se recargue

            const foto = await getFotoDataUrl();

            // Recolectamos todos los campos del formulario
            const datos = {
                nombres: document.getElementById('nombre').value,
                apellidos: document.getElementById('apellidos').value,
                edad: Number(document.getElementById('edad').value),
                cedulaEstudiante: document.getElementById('cedulaEstudiante').value,
                fechaNacimiento: document.getElementById('fechaNacimiento').value,
                sexo: document.getElementById('sexo').value,
                jornada: document.getElementById('jornada').value,
                anioLectivo: document.getElementById('anioLectivo').value,
                email: document.getElementById('email').value,
                telefono: document.getElementById('telefono').value,
                curso: document.getElementById('curso').value,
                paralelo: document.getElementById('paralelo').value,
                direccion: document.getElementById('direccion').value,
                nombreRepresentante: document.getElementById('nombreRepresentante').value,
                cedulaRepresentante: document.getElementById('cedulaRepresentante').value,
                telefonoRepresentante: document.getElementById('telefonoRepresentante').value,
                foto: foto,
                // Nuevos campos
                codigoEstudiante: document.getElementById('codigoEstudiante').value,
                nacionalidad: document.getElementById('nacionalidad').value,
                etnia: document.getElementById('etnia').value,
                discapacidad: document.getElementById('discapacidad').value,
                direccionRepresentante: document.getElementById('direccionRepresentante').value,
                descripcionObservaciones: document.getElementById('descripcionObservaciones').value
            };

            // Enviamos al main.js para que mongoose lo guarde en Atlas
            ipcRenderer.send('guardar-registro', datos);
        });

        document.getElementById('btnCancelar').addEventListener('click', () => {
            ipcRenderer.send('cerrar-modal');
        });
    </script>
</body>

</html>